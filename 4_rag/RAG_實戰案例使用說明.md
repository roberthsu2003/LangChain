# 📚 RAG 實戰案例使用說明

> 本文檔說明如何運行和使用兩個 RAG 實戰案例

---

## 🎯 案例概覽

### 案例 1：智慧文檔問答系統
**檔案**：`case1_smart_document_qa_system.py`  
**Port**：7860  
**難度**：⭐⭐⭐⭐

**功能特色**：
- 📖 單一文檔或全部文檔智能問答
- 🔍 支援 Metadata 過濾
- ⚙️ 可調整檢索策略（Similarity / MMR）
- 📊 顯示來源文檔和參考資料
- 🎨 美觀的格式化輸出

**適用場景**：
- 企業知識庫查詢
- 客戶服務系統
- 技術文檔支援
- 產品使用手冊問答

---

### 案例 2：多文檔智能比較系統
**檔案**：`case2_document_comparison_system.py`  
**Port**：7861  
**難度**：⭐⭐⭐⭐⭐

**功能特色**：
- 🔄 並行檢索 2-3 個文檔
- 📊 智能比較分析（相似點、差異點、優缺點）
- 💡 提供選擇建議
- 🎯 適合產品比較和政策對照
- 🚀 使用 RunnableParallel 提升效率

**適用場景**：
- 產品規格比較
- 服務方案選擇
- 合約條款對照
- 政策規範分析

---

## 🚀 快速開始

### 方法 1：使用執行腳本（推薦）

```bash
# 案例 1
cd 4_rag
./run_case1.sh

# 案例 2
./run_case2.sh
```

### 方法 2：手動執行

```bash
# 1. 啟用 langchain 環境
conda activate langchain

# 2. 進入資料夾
cd 4_rag

# 3. 運行案例
# 案例 1
python case1_smart_document_qa_system.py

# 案例 2
python case2_document_comparison_system.py
```

---

## 📋 環境需求

### 必要套件

```bash
pip install langchain
pip install langchain-community
pip install langchain-ollama
pip install langchain-huggingface
pip install chromadb
pip install gradio
pip install sentence-transformers
pip install python-dotenv
```

### 系統需求

- Python 3.11+
- Ollama（需安裝 llama3.2:latest 模型）
- 約 2GB 可用磁碟空間（向量資料庫）
- 約 4GB RAM

---

## 📚 使用的資料

兩個案例都使用 `books/` 資料夾中的 8 本繁體中文使用手冊：

1. 智慧型手機使用手冊
2. 洗衣機使用說明
3. 冷氣機安裝維護手冊
4. 路由器設定手冊
5. 電動機車使用手冊
6. 信用卡權益說明
7. 健保就醫指南
8. 租屋契約範本與說明

---

## 🎮 案例 1 使用指南

### 介面說明

**左側面板**：
- **問題輸入框**：輸入您的問題
- **文檔範圍選擇**：選擇要搜尋的文檔（或全部）
- **進階設定**（可展開）：
  - 檢索結果數量：1-10 個
  - 檢索策略：Similarity / MMR

**右側面板**：
- 顯示 AI 回答
- 顯示參考資料來源
- 顯示檢索設定資訊

### 範例問題

```
1. "如何設定 WiFi？" - 選擇「路由器設定手冊」
2. "手機如何省電？" - 選擇「智慧型手機使用手冊」
3. "洗衣機如何清潔？" - 選擇「洗衣機使用說明」
4. "冷氣機如何保養？" - 選擇「冷氣機安裝維護手冊」
5. "信用卡有什麼優惠？" - 選擇「信用卡權益說明」
```

### 技巧建議

**1. 選擇適當的文檔範圍**
- ✅ 知道要查哪本手冊 → 選擇特定文檔（更精準）
- ✅ 不確定在哪本手冊 → 選擇「全部文檔」（更全面）

**2. 調整檢索策略**
- **Similarity**：精確查詢，適合找特定資訊
- **MMR**：多樣化結果，適合探索性查詢

**3. 調整結果數量**
- 簡單問題：k=2-3
- 複雜問題：k=5-7
- 探索性問題：k=8-10

---

## 🎮 案例 2 使用指南

### 介面說明

**左側面板**：
- **比較問題輸入**：輸入您想比較的問題
- **選擇文檔 1, 2, 3**：選擇要比較的文檔（至少 2 個）
- **進階設定**：每個文檔的檢索數量

**右側面板**：
- 顯示比較問題
- 顯示比較對象
- 顯示比較分析結果（相似點、差異點、優缺點、建議）
- 顯示技術說明

### 範例比較問題

```
1. "如何設定網路連線？"
   比較：路由器設定手冊 vs 智慧型手機使用手冊

2. "清潔和保養的方式有什麼不同？"
   比較：洗衣機使用說明 vs 冷氣機安裝維護手冊

3. "有哪些保固條款？"
   比較：智慧型手機 vs 洗衣機 vs 冷氣機

4. "如何申請權益？"
   比較：信用卡權益說明 vs 健保就醫指南

5. "安全注意事項有哪些差異？"
   比較：電動機車 vs 智慧型手機
```

### 技巧建議

**1. 選擇適合比較的文檔**
- ✅ 同類產品：手機 vs 洗衣機 vs 冷氣機
- ✅ 相關功能：路由器 vs 手機（網路設定）
- ✅ 相似主題：信用卡 vs 健保（權益申請）

**2. 提出有意義的比較問題**
- ✅ "保固期限有什麼差異？"
- ✅ "安全注意事項有哪些不同？"
- ✅ "哪個更適合老年人使用？"
- ❌ "價格多少？"（文檔中可能沒有）

**3. 理解比較結果**
- 📊 相似點：共同特徵
- 📊 差異點：主要區別
- 💡 優缺點：各自特色
- 🎯 建議：選擇指引

---

## 🔧 常見問題

### Q1: 首次運行很慢？
**A**: 首次運行需要：
1. 下載 Embedding 模型（約 500MB）
2. 建立向量資料庫（約 2-3 分鐘）
3. 後續運行會直接載入，速度快很多

### Q2: 顯示「向量資料庫未初始化」？
**A**: 檢查：
1. `books/` 資料夾是否存在
2. 資料夾中是否有 .txt 檔案
3. 檔案編碼是否為 UTF-8

### Q3: 回答不準確怎麼辦？
**A**: 可以嘗試：
1. 增加檢索結果數量（k 值）
2. 切換檢索策略（Similarity ↔ MMR）
3. 選擇特定文檔而非「全部文檔」
4. 更精確地描述問題

### Q4: 如何清除向量資料庫重建？
**A**: 
```bash
# 刪除向量資料庫
rm -rf db/

# 重新運行案例，會自動重建
python case1_smart_document_qa_system.py
```

### Q5: 可以使用自己的文檔嗎？
**A**: 可以！
1. 將 .txt 檔案放入 `books/` 資料夾
2. 修改案例程式碼中的 `AVAILABLE_DOCS` 字典
3. 刪除舊的 `db/` 資料夾
4. 重新運行案例

### Q6: 如何同時運行兩個案例？
**A**: 兩個案例使用不同 Port，可以同時運行：
```bash
# Terminal 1
./run_case1.sh  # Port 7860

# Terminal 2
./run_case2.sh  # Port 7861
```

---

## 💡 技術解析

### 案例 1 的技術架構

```
使用者問題
    ↓
Metadata 過濾（選擇文檔）
    ↓
向量檢索（Chroma）
    ↓
格式化文檔（format_docs）
    ↓
RAG Prompt Template
    ↓
Ollama LLM
    ↓
格式化輸出
    ↓
顯示結果 + 來源
```

**關鍵技術**：
- `filter={"source_name": doc_name}` - Metadata 過濾
- `search_type="similarity"` 或 `"mmr"` - 檢索策略
- `RunnablePassthrough` - 傳遞變數
- RAG Chain 組合

### 案例 2 的技術架構

```
使用者問題
    ↓
建立多個檢索器（每個文檔一個）
    ↓
RunnableParallel（並行檢索）
    ├─→ Retriever 1 → 文檔 1 內容
    ├─→ Retriever 2 → 文檔 2 內容
    └─→ Retriever 3 → 文檔 3 內容
    ↓
比較 Prompt Template
    ↓
Ollama LLM
    ↓
比較分析結果
    ↓
格式化顯示
```

**關鍵技術**：
- `RunnableParallel` - 並行執行多個檢索
- 多個獨立 Retriever
- 專門的比較 Prompt
- 結構化輸出格式

---

## 🎓 學習建議

### 初學者
1. 先運行案例 1，理解基本 RAG 流程
2. 嘗試不同的問題和設定
3. 觀察不同檢索策略的差異
4. 理解 Metadata 過濾的作用

### 進階開發者
1. 研究兩個案例的程式碼實作
2. 理解 RunnableParallel 的運作原理
3. 嘗試修改 Prompt Template
4. 添加新功能（如對話記憶）

### 專案開發者
1. 使用案例作為範本
2. 替換成自己的文檔資料
3. 客製化介面和功能
4. 整合到生產環境

---

## 🔗 相關資源

- [RAG 章節測驗](quiz_rag.md) - 檢測學習成果
- [README.md](README.md) - 完整的 RAG 教學
- [向量資料庫與嵌入模型](向量資料庫與嵌入模型.md) - 深入理解技術原理
- Jupyter Notebooks（1-8） - 循序漸進學習

---

## 🤝 貢獻與回饋

如果您在使用過程中遇到問題或有改善建議，歡迎：
- 提交 Issue
- 提出改善建議
- 分享使用心得

---

**祝您學習愉快！💪**

